# nginx

*   内部变量 <https://nginx.org/en/docs/varindex.html>



```shell
cat > /etc/yum.repos.d/mysql-community.repo << EOF
[nginx-stable]
name=nginx stable repo
baseurl=https://nginx.org/packages/centos/\$releasever/\$basearch
gpgcheck=1
enabled=1
gpgkey=https://nginx.org/keys/nginx_signing.key
module_hotfixes=true
EOF
yum makecache
yum install nginx -y
systemctl enable nginx
```



### 限速

<https://nginx.org/en/docs/http/ngx_http_limit_req_module.html>

```nginx
limit_req_zone $binary_remote_addr zone=addr:10m rate=40r/s;
limit_req zone=addr burst=50;
```





## http/2

自动降级为http/1.1：

1.  防病毒软件是MITM的流量，因此将其降级为http/1.1。关闭以直接连接到服务器
2.  使用较旧的TLS密码 <https://http2.github.io/http2-spec/#BadCipherSuites>
3.  SSL/TLS库中缺少ALPN支持，nginx需要以openssl1.0.2或更高版本构建
4.  nginx 1.9.5以上



不支持：<span style="color:#808080">虽然安装的openssl是大于1.0.2，但是构建的版本却是1.0.1e</span>

```shell
[root@localhost ~]# yum list installed |grep openssl
openssl.x86_64                  1.0.1e-58.el6_10                 @updates       

[root@localhost ~]# nginx -V
nginx version: nginx/1.16.1
built by gcc 4.4.7 20120313 (Red Hat 4.4.7-23) (GCC) 
built with OpenSSL 1.0.1e-fips 11 Feb 2013
TLS SNI support enabled
configure arguments: --prefix=/etc/nginx ...
```

构建 [点击](https://liuq.org/org/SYSTEM/WEB服务器/nginx/build_rpm.txt)

安装

```shell
yum localinstall https://liuq.org/down/nginx-99.1.16.1-1.x86_64.rpm
```

配置

```nginx
server {
    listen 80 default_server;
    location / {
        return 301 https://$host$request_uri;
    }
}

server {
    listen 443 ssl http2 default_server;
 
    ssl_certificate     server.crt;
    ssl_certificate_key server.key;
    ...
}
```



测试网站 <https://tools.keycdn.com/http2-test>

>   参考：
>
>   [具有HTTP / 2支持的开源NGINX 1.9.5发布](https://www.nginx.com/blog/nginx-1-9-5)
>   [为什么Chrome浏览器无法识别我的Nginx http2服务器](https://serverfault.com/questions/820471/why-chrome-browser-doesnt-recognize-my-nginx-http2-server)





```shell
wget -c https://www.openssl.org/source/openssl-1.0.2t.tar.gz
tar -xvf openssl-1.0.2t.tar.gz
sudo mkdir -vp /opt/cpnginx/openssl
sudo cp -vrf openssl-1.0.2t/* /opt/cpnginx/openssl/
```



安装

```shell
sudo yum install -y nginx
sudo systemctl enable nginx
```



使用配置文件

```nginx
user             nginx nginx;
worker_processes auto;
pid              /var/run/nginx.pid;
error_log        /var/log/nginx/error.log;

events {
    worker_connections 65535;
    multi_accept       on;
    use                epoll;
}

http {

    log_format  main  '$remote_addr|$http_x_real_ip - $remote_user [$time_local] "$host $request $request_body" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
    access_log   off;

    include      /etc/nginx/mime.types;
    default_type application/octet-stream;

    server_tokens off;
    sendfile      on;
    tcp_nodelay   on;

    gzip            on;
    gzip_proxied    any;
    gzip_comp_level 4;
    gzip_min_length 1000;
    gzip_types      *;

    # 为了获取用户真实IP
    set_real_ip_from 192.168.0.0/16;
    set_real_ip_from 10.0.0.0/8;
    set_real_ip_from 127.0.0.1;
    real_ip_header   X-Forwarded-For;

    # 超时
    # client_header_timeout   4000s;
    # client_body_timeout     4000s;
    # keepalive_timeout       4000s;
    # proxy_connect_timeout   4000s;
    # proxy_read_timeout      4000s;
    # proxy_send_timeout      4000s;
    # fastcgi_connect_timeout 4000s;
    # fastcgi_read_timeout    4000s;
    # fastcgi_send_timeout    4000s;


    # include /etc/nginx/conf.d/*.conf;
    #server {
    #    listen 80 default_server;
    #    server_name _;
    #    return 500;
    #}
    #server {
    #    listen 443 ssl default_server;
    #    server_name _;
    #    ssl_certificate     /keys/server.crt;
    #    ssl_certificate_key /keys/server.pem;
    #    return 500;
    #}
    server {
        # 看以下
    }
}
```

```nginx
# http带参数301重定向到https
server {
    listen 80;
    return 301 https://$host$request_uri;
}

# 监控用
server {
    listen     127.0.0.1:81;
    access_log off;

    location = /nginx-status {
        stub_status on;
    }
    location = /phpfpm-status {
        include       fastcgi_params;
        fastcgi_pass  127.0.0.1:9000;
        fastcgi_param SCRIPT_FILENAME $fastcgi_script_name;
    }
}

# 主项目使用
server {
    listen 80;
    root   /opt/www;
    index  index.html index.php;

    location / {
        if (!-e $request_filename) {
            rewrite ^(.*)$ /index.php?s=$1 last;
            break;
        }
    }
    location ~ \.php$ {
        access_log /var/log/nginx/access.log main;
        if ( "$request_filename" != "/opt/www/php/public/index.php" ) {
            return 403;
        }
        try_files     $uri =404;
        fastcgi_pass  127.0.0.1:9000;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include       fastcgi_params;
    }

    location ^~ /.git/    { return 403; }
    location ^~ /Runtime/ { return 403; }
    location ^~ /Uploads/ { location ~ \.php$ {return 403;} }
}

# websocket
server {
    listen 80;
    location / {
        proxy_read_timeout 24h;
        proxy_send_timeout 24h;
        client_max_body_size 0;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://127.0.0.1:8282;
    }
}
```

```nginx
# 前后端分离配置

# php
server {
    listen 127.0.0.1:8080;
    root   /opt/www/php/public;
    index  index.html index.php;

    location / {
        if (!-e $request_filename) {
            rewrite ^(.*)$ /index.php?s=$1 last;
            break;
        }
    }
    location ~ \.php$ {
        access_log  /var/log/nginx/access.log  main;
        if ( "$request_filename" != "/opt/www/php/public/index.php" ) {
            return 403;
        }
        try_files $uri =404;
        fastcgi_pass  127.0.0.1:9000;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include       fastcgi_params;
    }
}

# admin page
server {
    listen 80;
    server_name admin.com;

    # 仅仅允许管理员IP
    allow 192.168.0.0/16;
    allow 10.0.0.0/8;
    allow 127.0.0.1;
    deny all;

    location / {
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://127.0.0.1:8080;
    }
}

# api
server {
    listen 80;
    server_name api.local;

    # 仅仅允许内网
    allow 192.168.0.0/16;
    allow 10.0.0.0/8;
    allow 127.0.0.1;
    deny all;

    location / {
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://127.0.0.1:8080/api/;
    }
}

# html page
server {
    listen 80;
    root   /opt/www/html/pc;
    index  index.html;
    server_name www.com;

    location / {
        if ($http_user_agent ~* "(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino") {
            root /opt/www/html/mobile;
        }
    }
    location ~* /server/(admin|api).* {
        return 403;
    }
    location ~ /server/(.*) {
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://127.0.0.1:8080/$1?$query_string;
    }
}
```



