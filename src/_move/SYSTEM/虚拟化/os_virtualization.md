### 虚拟化

虚拟化技术主要分为以下几个大类：

* 平台虚拟化（Platform Virtualization），针对计算机和操作系统的虚拟化
* 资源虚拟化（Resource Virtualization），对特定的系统资源的虚拟化，比如内存、存储、网络资源等
* 应用程序虚拟化（Application Virtualization），包括仿真、模拟、解释技术等

主要介绍平台虚拟化

#### 实现方式

* 纯软件虚拟化
  * 通过模拟完整的硬件环境来虚拟化 Guest 平台
    * 解决方案：QEMU Bochs PearPC
  * 模拟 x86、ARM、PowerPC 等 CPU 指令集
    * 优点：不用购买需要的硬件
    * 缺点：效率比较低 
* 虚拟化翻译
  * Guset OS 运行在 ring 1 中，执行特权指令时会出现异常，由 VMM 捕获这些异常并翻译再返回给 guest
  * 机制：异常--&gt;捕获--&gt;翻译
* 容器技术
  * LXC 和 Docker

Guest OS 也是一个完整的 OS，它认为自己在真实的硬件中运行，所以它向 CPU 索取 ring 0，但是 Host OS 已经占用了 ring 0

有三种解决方案

* 没有硬件辅助的全虚拟化
* 半虚拟化
* 有硬件辅助的虚拟化
  * CPU 厂商在 cpu 中增加对虚拟化

---

#### X86 CPU保护环![](/assets/截图 - 2017年05月18日 - 19时48分47秒.png)

x86在设计上是直接在硬件上运行，它被设计成占有所有计算机的硬件

包含了4个特权的运行级别，提供给OS及程序

例如 linux kernel 需要访问 memory，disk，network 等，则需要运行在最高级别 ring 0 中，这样才能操作中断、修改列表、访问硬件设备等。

其他的程序则运行在最低级别 ring 3 中，程序不能做受限制的操作，如操作内存、读写文件，这必须执行系统相关调用，或执行某些函数，这样 CPU 就会在运行级别上切换，并跳转到相关的代码中，由 kernel 代替程序操作设备，操作完毕就会切换回 ring 3 中，这过程称之为“用户态和内核态的切换”

---

#### 全虚拟化

没有硬件辅助的虚拟化

解决方案：QEMU、VMware Workstation、Virtual PC

![](/assets/截图 - 2017年05月18日 - 21时44分49秒.png)

全虚拟化是指虚拟机模拟了完整的底层硬件，包括处理器、物理内存、时钟、外设等，使得为原始硬件设计的操作系统或其它系统软件完全不做任何修改就可以在虚拟机中运行。操作系统与真实硬件之间的交互可以看成是通过一个预先规定的硬件接口进行的。全虚拟化 VMM 以完整模拟硬件的方式提供全部接口（同时还必须模拟特权指令的执行过程）。

Host OS 是通过 VMM（Hypervisor）来翻译 Guest OS 中的 ring 0 代码，并将结果返回给 guest

流程：Guest OS 运行在 ring 1，Guest OS 运行 ring 0 代码会出现异常，由 VMM 捕获并执行，再将执行结果返回给 guest  
机制：异常--&gt; 捕获 --&gt; 翻译

全虚拟化的运行速度要快于硬件模拟, 但是性能方面不如裸机, 因为 VMM 需要占用一些资源. 全虚拟化最大的优点是操作系统没有经过任何修改. 限制是 Host OS 必须能够支持底层硬件且性能较底

### 半虚拟化

也称为：超虚拟化、操作系统辅助虚拟化

解决方案：Denali、Xen

![](/assets/截图 - 2017年05月18日 - 22时26分27秒.png)

这是一种修改 Guest OS 部分访问特权状态的代码以便直接与 VMM 交互的技术。

Guest OS 不能直接运行在 ring 0 中，需要对 kernel 修改，之后指令直接转为调用 VMM

![](/assets/截图 - 2017年05月18日 - 22时25分39秒.png)

在关键的指令改为可以调用 VMM 通信，这样 Guest OS 就知道自身运行在虚拟化平台上，省去了 异常--&gt; 捕获 --&gt; 翻译 这个流程，提高了执行效率。Guest OS 中的 apps 还是运行在 ring 3 中

在超虚拟化虚拟机中，部分硬件接口以软件的形式提供给客户机操作系统，这可以通过 Hypercall（VMM 提供给 Guest OS 的直接调用，与系统调用类似）的方式来提供。例如，Guest OS 把切换页表的代码修改为调用 Hypercall 来直接完成修改影子 CR3 寄存器和翻译地址的工作。由于不需要产生额外的异常和模拟部分硬件执行流程，超虚拟化可以大幅度提高性能，比较著名的 VMM 有 。

### 硬件辅助的虚拟化

解决方案：KVM、Xen-3.0、VMware ESXI、Microsoft Hypre-V

![](/assets/截图 - 2017年05月18日 - 22时41分18秒.png)

AMD-V 和 Intel VT 创建了一个新的 ring -1 单独给 VMM 使用，Guest OS 可直接使用 ring 0 而无需修改

Host OS 最高级别在 ring -1 中，因为将 ring 0 分配给 VMM 了，这就给 Host OS 带来了一点麻烦：

* 麻烦1：Host OS 降低了少许性能
* 麻烦2：Host OS 降低了兼容性

这就是大部分某些消费类型PC会从BIOS/CMOS中禁用虚拟化的原因

---

#### Hypervisor

又称虚拟机器监视器（英语：virtual machine monitor，缩写为 VMM），是用来建立与执行虚拟机器的部分电脑软件、固件或硬件。

![](/assets/截图 - 2017年05月19日 - 20时35分23秒.png)

类型1：裸金属型、本地型、裸机型

* 虚拟机管理程序直接运行在 Host OS 来控制硬件和管理 Ghost OS
* 特点
  * 需要硬件支持
  * 虚拟机监视器作为主操作系统
  * 运行效率高

类型2：宿主型

* 虚拟机管理程序运行在传统的操作系统上，就像其他计算机程序那样运行
* 特点
  * 虚拟机监视器作为应用程序运行在主操作系统环境内
  * 运行效率一般较 类型1 低

---

#### 容器

![](/assets/截图 - 2017年05月19日 - 20时51分42秒.png)

由 linux kernel 支持的轻量级 OS 虚拟化方式，源于 chroot\(root监牢\) 调用

优势：

* 更快速的交付和部署
* 更高效的虚拟化
* 更轻松的迁移和拓展
* 更方便的管理

---

> Trap-And-Emulate 、AMD-V、Intel VT的处理方式
>
> 参考
>
> [51CTO 学院视频](http://edu.51cto.com/lesson/id-118659.html)  
> [IBM 虚拟化技术漫谈](https://www.ibm.com/developerworks/cn/linux/l-cn-vt/)  
> [维基百科条目](https://zh.wikipedia.org/zh-sg/Hypervisor)



